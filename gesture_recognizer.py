"""
手勢辨識模組（GestureRecognizer）
===================================

此模組負責「把每根手指是伸直(1)/彎曲(0)」的資訊，轉成有意義的手勢名稱：

1. 將 `HandDetector.fingers_up()` 回傳的陣列（例如 [0,1,1,0,0]）轉換為：
   - 數字手勢：0~9
   - 特殊手勢：Like / OK / ROCK / FUCK
2. 透過「精確對照表」判斷手勢，不使用模糊規則，避免誤判
3. 回傳「手勢代號 (int)」與「名稱 (str)」，供 `web_app.py` 或 `main.py` 顯示

輸入格式（fingers）：
----------------------
    [thumb, index, middle, ring, pinky]

- 每個位置為 0 或 1：
  - 1 = 這根手指被判定為「伸直」
  - 0 = 這根手指被判定為「彎曲」

範例：
    [0, 1, 0, 0, 0] → 只有食指 → 數字 1
    [0, 1, 1, 0, 0] → 食指 + 中指 → 數字 2
    [1, 0, 0, 0, 0] → 只有大拇指 → Like（讚）

輸出格式：
----------
`recognize_number(fingers)` 會回傳兩個值：

    gesture_id (int), gesture_name (str)

- gesture_id:
  - 0~9  ：代表數字 0~9
  - 10~13：代表特殊手勢（10: Like, 11: OK, 12: ROCK, 13: FUCK）
  - -1   ：無法識別（不在對照表中的組合）

- gesture_name:
  - "0" ~ "9"
  - "Like" / "OK" / "ROCK" / "FUCK"
  - "Unknown"（無法識別）

注意：
------
- 雙手組合（例如「兩位數」或「Like+OK」）並不在此模組處理，
  而是由 `web_app.py` 依左右手的結果「再組合」起來：
  - 若兩隻手都是 0~9：左手當十位數、右手當個位數
  - 若任一隻手為特殊手勢：用「名稱+名稱」方式表示（例如 "Like+OK"）
"""


class GestureRecognizer:
    def __init__(self):
        """
        初始化手勢辨識器
        
        建立手勢代號到名稱的映射表
        """
        # 手勢對應的名稱
        self.gesture_names = {
            # 數字 0-9
            0: "0",
            1: "1",
            2: "2",
            3: "3",
            4: "4",
            5: "5",
            6: "6",
            7: "7",
            8: "8",
            9: "9",
            # 特殊手勢
            10: "Like",      # 讚
            11: "OK",        # OK手勢
            12: "ROCK",      # 搖滾手勢
            13: "FUCK"       # 中指
        }
    
    def recognize_number(self, fingers):
        """
        根據手指的伸直/彎曲狀態識別數字(0-9)和特殊手勢
        
        手勢定義：
        - 0: 握拳 [0,0,0,0,0]
        - 1: 食指 [0,1,0,0,0]
        - 2: 食指+中指 [0,1,1,0,0]
        - 3: 食指+中指+無名指 [0,1,1,1,0]
        - 4: 食指+中指+無名指+小指 [0,1,1,1,1]
        - 5: 全部手指 [1,1,1,1,1]
        - 6: 拇指+小指 [1,0,0,0,1]
        - 7: 拇指+食指 [1,1,0,0,0]
        - 8: 拇指+食指+中指 [1,1,1,0,0]
        - 9: 拇指+食指+中指+無名指 [1,1,1,1,0]
        - Like(讚): 只有拇指 [1,0,0,0,0]
        - OK: 中指+無名指+小指 [0,0,1,1,1]
        - ROCK: 拇指+中指+小指 [1,0,1,0,1]
        - FUCK: 只有中指 [0,0,1,0,0]
        
        參數:
            fingers (list): [大拇指, 食指, 中指, 無名指, 小指]
        
        返回:
            gesture_id (int): 手勢代號 (0-9: 數字, 10+: 特殊手勢, -1: 未知)
            gesture_name (str): 手勢名稱
        """
        # 檢查輸入是否有效
        if len(fingers) != 5:
            return -1, "Unknown"
        
        # 將列表轉為元組，方便比對
        finger_pattern = tuple(fingers)
        
        # ===== 精確匹配手勢 =====
        # 使用字典進行精確匹配，更清晰易維護
        
        gesture_patterns = {
            # 數字 0-9
            (0, 0, 0, 0, 0): (0, "0"),              # 0: 握拳
            (0, 1, 0, 0, 0): (1, "1"),              # 1: 食指
            (0, 1, 1, 0, 0): (2, "2"),              # 2: 食指+中指
            (0, 1, 1, 1, 0): (3, "3"),              # 3: 食指+中指+無名指
            (0, 1, 1, 1, 1): (4, "4"),              # 4: 食指+中指+無名指+小指
            (1, 1, 1, 1, 1): (5, "5"),              # 5: 全部
            (1, 0, 0, 0, 1): (6, "6"),              # 6: 拇指+小指
            (1, 1, 0, 0, 0): (7, "7"),              # 7: 拇指+食指
            (1, 1, 1, 0, 0): (8, "8"),              # 8: 拇指+食指+中指
            (1, 1, 1, 1, 0): (9, "9"),              # 9: 拇指+食指+中指+無名指
            
            # 特殊手勢
            (1, 0, 0, 0, 0): (10, "Like"),          # 讚：只有拇指
            (0, 0, 1, 1, 1): (11, "OK"),            # OK：中指+無名指+小指
            (1, 1, 0, 0, 1): (12, "ROCK"),          # ROCK：拇指+食指+小指
            (0, 0, 1, 0, 0): (13, "FUCK"),          # FUCK：只有中指
        }
        
        # 查找匹配的手勢
        if finger_pattern in gesture_patterns:
            gesture_id, gesture_name = gesture_patterns[finger_pattern]
            return gesture_id, gesture_name
        else:
            # 沒有匹配的手勢
            return -1, "Unknown"
    
    def get_gesture_description(self, gesture_id):
        """
        獲取手勢的詳細描述
        
        參數:
            gesture_id (int): 手勢代號
            
        返回:
            description (str): 該手勢的描述
        """
        descriptions = {
            # 數字 0-9
            0: "握拳（所有手指彎曲）",
            1: "只伸出食指",
            2: "食指+中指",
            3: "食指+中指+無名指",
            4: "食指+中指+無名指+小指",
            5: "張開手掌（所有手指伸直）",
            6: "拇指+小指",
            7: "拇指+食指",
            8: "拇指+食指+中指",
            9: "拇指+食指+中指+無名指",
            # 特殊手勢
            10: "只伸出大拇指（讚）",
            11: "中指+無名指+小指（OK）",
            12: "拇指+食指+小指（搖滾）",
            13: "只伸出中指"
        }
        
        return descriptions.get(gesture_id, "未知手勢")


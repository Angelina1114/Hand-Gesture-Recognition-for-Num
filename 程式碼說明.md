# 程式碼詳細說明

本文檔說明手勢辨識系統的程式碼結構和工作原理。

## 📁 檔案結構

```
數字辨識/
├── hand_detector.py          # 手部檢測模組 ⭐
├── gesture_recognizer.py     # 手勢辨識模組 ⭐
├── web_app.py                # 網頁應用程式 ⭐
├── main.py                   # 桌面版程式
├── templates/
│   └── index.html           # 網頁介面
└── requirements.txt          # Python 依賴套件
```

## 🔍 核心模組詳解

### 1. hand_detector.py - 手部檢測模組

**作用**: 使用 Google MediaPipe 檢測手部並識別手指狀態

**主要類別**: `HandDetector`

**關鍵方法**:

#### `__init__()` - 初始化
```python
detector = HandDetector(
    max_hands=1,              # 只檢測一隻手（提高性能）
    detection_confidence=0.7  # 檢測信心度閾值
)
```

#### `find_hands(img, draw=True)` - 檢測並繪製手部
```python
# 流程：
# 1. BGR → RGB 轉換
# 2. MediaPipe 檢測手部
# 3. 繪製 21 個關鍵點和連接線
img = detector.find_hands(frame, draw=True)
```

#### `find_position(img)` - 獲取關鍵點座標
```python
# 返回 21 個關鍵點的像素座標
# 格式: [(id, x, y), ...]
landmark_list = detector.find_position(frame)
# 例如: [(0, 320, 240), (1, 305, 235), ...]
```

#### `fingers_up(landmark_list)` - 判斷手指狀態
```python
# 返回每根手指的狀態
# 格式: [大拇指, 食指, 中指, 無名指, 小指]
fingers = detector.fingers_up(landmark_list)
# 例如: [0, 1, 1, 0, 0] → 食指和中指伸直
```

**手指判斷原理**:
- **大拇指**: 比較指尖和根部的水平距離（因為大拇指是橫向的）
- **其他手指**: 比較指尖和關節的垂直位置（伸直時指尖在上方）

### 2. gesture_recognizer.py - 手勢辨識模組

**作用**: 根據手指狀態識別數字手勢（0-5）

**主要類別**: `GestureRecognizer`

**關鍵方法**:

#### `recognize_number(fingers)` - 識別數字
```python
# 輸入: [0, 1, 1, 0, 0]  # 食指和中指伸直
# 輸出: (2, "二")         # 數字 2

number, name = recognizer.recognize_number(fingers)
```

**識別規則**:

| 伸直手指數 | 手指組合 | 識別為 |
|-----------|---------|--------|
| 0 | 所有彎曲 | 零 (握拳) |
| 1 | 食指或大拇指 | 一 |
| 2 | 食指+中指 或 大拇指+食指 | 二 |
| 3 | 三根手指（多種組合） | 三 |
| 4 | 四根手指 | 四 |
| 5 | 所有伸直 | 五 |

### 3. web_app.py - 網頁應用程式

**作用**: 提供網頁介面，支援遠端訪問

**技術架構**:
- **後端**: Flask (Python 網頁框架)
- **串流**: MJPEG (Motion JPEG)
- **前端**: HTML5 + CSS3 + JavaScript

**主要功能**:

#### Flask 路由

```python
# 1. 首頁
@app.route('/')
def index():
    # 返回 HTML 頁面
    
# 2. 視訊串流
@app.route('/video_feed')
def video_feed():
    # 返回 MJPEG 串流
    # 用法: <img src="http://IP:5000/video_feed">
    
# 3. 手勢數據 API
@app.route('/gesture_data')
def gesture_data():
    # 返回 JSON: {"number": 2, "name": "二", "confidence": 100}
```

#### 影像處理流程

```python
def generate_frames():
    while True:
        # 1. 讀取攝像頭
        frame = camera.read()
        
        # 2. 鏡像翻轉
        frame = cv2.flip(frame, 1)
        
        # 3. 檢測手部
        frame = detector.find_hands(frame)
        landmark_list = detector.find_position(frame)
        
        # 4. 識別手勢
        fingers = detector.fingers_up(landmark_list)
        number, name = recognizer.recognize_number(fingers)
        
        # 5. 穩定性過濾（連續檢測 5 次才認定）
        if stable_count >= 5:
            # 更新結果
            current_gesture = {"number": number, ...}
        
        # 6. 繪製結果
        cv2.putText(frame, f"數字: {number}", ...)
        
        # 7. 編碼為 JPEG
        buffer = cv2.imencode('.jpg', frame, quality=95)
        
        # 8. 返回影像（yield 生成器）
        yield b'--frame\r\n' + buffer + b'\r\n'
```

## 🔄 系統工作流程

```
┌─────────────┐
│  攝像頭捕捉  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  影像預處理  │ ← 鏡像翻轉
└──────┬──────┘
       │
       ▼
┌─────────────┐
│ MediaPipe   │ ← 檢測 21 個手部關鍵點
│ 手部檢測     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  手指狀態    │ ← 判斷每根手指伸直/彎曲
│  判斷        │    輸出: [0,1,1,0,0]
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  手勢辨識    │ ← 根據手指狀態識別數字
│              │    輸出: (2, "二")
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  穩定性過濾  │ ← 連續檢測 5 次才確認
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  結果顯示    │ ← 繪製在影像上 + 更新網頁
└─────────────┘
```

## 🎯 重要概念

### MediaPipe 手部關鍵點

MediaPipe 會檢測 **21 個關鍵點**：

```
        8   12  16  20    ← 指尖
        |   |   |   |
        7   11  15  19    ← 第二關節
        |   |   |   |
        6   10  14  18    ← 第一關節
        |   |   |   |
    4   5   9   13  17    ← 指根
    |   └───┴───┴───┘
    3
    |
    2
    |
    1
    |
    0  ← 手腕
```

### 穩定性過濾機制

為了避免誤判和抖動，系統使用**連續檢測**機制：

```python
stable_threshold = 5  # 需要連續檢測 5 次

if number == previous_number:
    stable_count += 1
else:
    stable_count = 1

# 只有當 stable_count >= 5 時才認定手勢有效
if stable_count >= stable_threshold:
    # 顯示結果
```

### MJPEG 串流

MJPEG 是一種簡單的視訊串流格式，本質上是連續發送 JPEG 圖片：

```
--frame
Content-Type: image/jpeg

[JPEG 數據 1]
--frame
Content-Type: image/jpeg

[JPEG 數據 2]
--frame
...
```

## 🔧 可調整參數

### hand_detector.py

```python
# 大拇指判斷閾值（像素距離）
if abs(thumb_tip_x - thumb_base_x) > 30:  # 可調整此值
    # 30 太小 → 容易誤判為伸直
    # 30 太大 → 不容易檢測到伸直
```

### web_app.py

```python
# 攝像頭解析度
CAMERA_WIDTH = 1280   # 越高畫質越好，但性能越差
CAMERA_HEIGHT = 720

# JPEG 壓縮質量
JPEG_QUALITY = 95     # 1-100，越高檔案越大但畫質越好

# 穩定性閾值
stable_threshold = 5  # 需要連續檢測幾次才認定為有效
```

## 💡 除錯技巧

### 1. 查看手指狀態

在 `web_app.py` 的檢測部分加入：

```python
fingers = detector.fingers_up(landmark_list)
print(f"手指狀態: {fingers}")  # 輸出到終端
```

### 2. 調整檢測信心度

```python
# 如果檢測不到手部，降低閾值
detector = HandDetector(detection_confidence=0.5)  # 從 0.7 降到 0.5

# 如果誤判太多，提高閾值
detector = HandDetector(detection_confidence=0.8)  # 從 0.7 提高到 0.8
```

### 3. 查看關鍵點座標

```python
landmark_list = detector.find_position(frame)
for id, x, y in landmark_list:
    print(f"點 {id}: ({x}, {y})")
```

## 📚 延伸學習

### 如何擴展到識別 6-10？

修改 `gesture_recognizer.py`:

```python
# 添加新的識別規則
elif total_fingers_up == 6:
    # 例如：一隻手的 5 + 另一隻手的 1
    number = 6
```

需要修改 `HandDetector` 參數：
```python
detector = HandDetector(max_hands=2)  # 檢測兩隻手
```

### 如何識別動態手勢？

需要記錄手部的**運動軌跡**：

```python
# 記錄歷史位置
history = []

# 每一幀添加當前位置
history.append((x, y))

# 分析軌跡
if is_swipe_left(history):
    gesture = "向左滑動"
```

## 🎓 總結

本系統的核心是三個模組的協作：

1. **HandDetector**: 檢測手部，識別手指狀態
2. **GestureRecognizer**: 根據手指狀態識別數字
3. **web_app**: 提供網頁介面和 API

所有程式碼都添加了詳細的中文註解，方便學習和修改！

